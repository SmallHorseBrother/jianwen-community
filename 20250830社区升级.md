### Jianwen Community 开发计划（v0.1）

#### 目标
- 打造“学伴匹配 + 学习/健身运营”的最小可用产品（MVP），提升群内互动质量与留存。
- 先修复安全/稳定性问题，再做用户可感知功能（打卡/榜单/合并内容中心），最后做增长功能（PK、自动重匹配等）。

---

### 当前状态快照
- 前端：React + TS + Vite；Auth、匹配中心、内容页、工具箱已接好。
- 后端：Supabase（DB + Auth + Storage + Edge Functions）。
- 函数：`match-users`、`user-connections` 已部署并在用。
- 已知问题：
  - Edge Functions 信任 body 里的 userId，且使用 service role（高危）。
  - 匹配函数 UUID in 过滤方式不稳。
  - `MatchingCenter` 缺少 `AlertCircle`、`Link` 导入（会编译失败）。
  - 活动类型前后端不统一（缺少 `match_request`）。

---

### 路线图（按优先级执行）

#### P0 立即修复（安全/阻断）
- 修复 Edge Functions 鉴权（从 Authorization 中取用户，不再信任 body，不默认用 service role）。
- 修复匹配函数的 UUID in 过滤。
- 修复前端缺失导入与活动类型不一致问题。

验收标准：
- 未登录请求 Edge Functions 返回 401。
- 用任意他人 userId 伪造请求无效。
- `MatchingCenter` 编译通过；匹配/创建连接正常。
- `npx supabase functions deploy` 后线上可用。

—

#### P1 合并“知识库/资源推荐”为统一内容中心
- 抽象通用文章列表组件，支持 `type`（learning/fitness）+ `content_kind`（knowledge/resource）+ `category` 过滤。
- 路由保留旧入口，但都落到统一页面并带默认筛选。

验收标准：
- 学习、健身的“知识库/资源”入口都展示统一 UI，过滤一致。
- 搜索/分类/加载效果正常。

—

#### P2 学习打卡 + 连续天数（streak）
- 新表 `checkins(user_id, date, type, payload)`；为用户生成连续天数、月视图与徽章位。
- 工具箱/学习页新增“今日打卡”、“连续 X 天”。

验收标准：
- 已登录用户可一键打卡，重复打卡处理正确。
- 个人页/学习页显示 streak；月视图可视化。
- 有基础的 RLS 策略保护数据。

—

#### P2.5 周榜/周报
- 基于 `checkins` 和活动聚合，生成周榜（Top N）与个人周报卡片（可分享）。
- 可先做 SQL 视图 + 简单查询接口（Edge Function 或直查）。

验收标准：
- 周榜可按学习次数/时长排序，支持分页。
- 个人周报展示核心指标，最近一周生成稳定。

—

#### P3 匹配增强与社区互动
- 匹配加入 `location/radius`、作息偏好、线上/线下偏好；每周自动推荐 Top 3。
- 给匹配对象提供“破冰问题/共同任务”模板。
- 将“大佬卡片墙”与匹配中心联动（卡片上可直接发起连接/匹配）。

—

#### P4 1v1 PK（MVP）
- 表：`challenges`, `challenge_participants`, `challenge_metrics`。
- 主题（词汇量/阅读时长/任务完成天数/训练计划天数），时长 1-7 天，简单结算与徽章。

—

### 详细实现说明（关键条目）

#### P0.1 Edge Functions 鉴权与权限收敛
- 目标：不信任 body 中的 `userId`；默认使用 anon client + 请求头 Authorization，让 RLS 生效。
- 做法：
  - 在函数里用 anon key 创建客户端，并透传请求头：
    ```ts
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      global: { headers: { Authorization: req.headers.get('Authorization') ?? '' } }
    });
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return 401;
    const userId = user.id; // 替代 body 里的 userId
    ```
  - 仅在确需超权写入时，短暂使用 service role，并对操作目标做严格校验。
  - 确认 `profiles/match_preferences/user_connections/community_activities` 的 RLS 满足业务：用户只能写自己的数据，读公开或与自己相关的数据。

验收测试：
- 无 Authorization 访问返回 401。
- 用他人 id 伪造请求无效；RLS 阻止越权写入。

—

#### P0.2 匹配函数的 `id in (...)` 修复
- 现状：`not('id','in','(a,b,c)')` 方式对 UUID 不稳。
- 改为：
  ```ts
  if (connectedUserIds.length > 0) {
    query = query.not('id', 'in', `(${connectedUserIds.map(id => `'${id}'`).join(',')})`);
    // 或者更安全：
    // query = query.in('id', allowIds) 的反向逻辑重构，或拆分 neq 多次
  }
  ```
- 更推荐：用 `.in('id', array)` 搭配正向集合，或先拿候选列表再过滤。

—

#### P0.3 前端小修
- `MatchingCenter` 增补导入：
  - `import { AlertCircle } from 'lucide-react';`
  - `import { Link } from 'react-router-dom';`
- `recordActivity` 类型补齐 `'match_request'`，与后端一致。
- 移除未使用图标导入，避免噪音。

—

#### P1 内容中心合并
- 新建 `src/components/Articles/ArticleList.tsx`（通用列表）
  - props：`type`, `contentKind`, `defaultCategory`
  - 复用 `getArticles`，仅调整过滤参数。
- `LearningKnowledge.tsx`/`FitnessKnowledge.tsx` 仅作为壳组件，传入不同 props。
- “资源推荐”入口复用该组件，默认 `contentKind=resource`。

—

#### P2 打卡 + streak
- SQL（概念设计）：
  - 表：`checkins(id, user_id uuid, date date, type text, payload jsonb, created_at timestamptz)`
  - 唯一键：`(user_id, date, type)`
  - 视图：`user_streaks(user_id, current_streak, longest_streak, last_checkin_date)`
- RLS：
  - 用户只能读/写自己的打卡。
- 前端：
  - 学习工具箱/学习首页：今日打卡按钮 + streak 展示。
  - 个人页：本月日历热力图（可后续）。

—

#### P2.5 周榜/周报
- 视图/函数：
  - `weekly_leaderboard`（user_id, week_start, score, rank）
  - 聚合来源：`checkins`（学习打卡数/时长）+ 活动（匹配/连接次数）。
- 前端：
  - `/community/leaderboard` 简页；个人页展示“我的周报”。

—

#### P3+（择优推进）
- 匹配加维度（地点/作息/偏好）；破冰问题模板；卡片墙联动。
- 1v1 PK MVP。

---

### 任务分解与执行清单

#### Sprint 1（P0 → P1）
- [ ] Edge Functions：改为从 Authorization 获取用户，移除对 body userId 的信任
- [ ] 修复 `id in` 过滤
- [ ] `MatchingCenter` 补导入与类型，统一 `match_request`
- [ ] 部署函数：`npx supabase functions deploy`
- [ ] 抽象通用文章列表组件，改两个知识库页指向通用组件
- [ ] 冒烟测试：登录/匹配/连接/文章列表

#### Sprint 2（P2）
- [ ] 新建 `checkins` 表 + RLS
- [ ] 学习页/工具箱加打卡入口；个人页显示 streak
- [ ] 数据校验：重复打卡、不同类型（learning/fitness）

#### Sprint 3（P2.5）
- [ ] 视图/函数：周榜聚合
- [ ] 前端 `/community/leaderboard` 页面
- [ ] 个人周报卡片

#### Sprint 4（P3）
- [ ] 匹配增强（地点、作息）
- [ ] 破冰问题、共同任务模板
- [ ] 卡片墙联动按钮

—

### 开发/部署指引

- 本地开发
  - 启动前端：`npm run dev`
  - 本地函数：`npx supabase start`（可选）→ `npx supabase functions serve <name>`
- 部署函数
  - 单个：`npx supabase functions deploy match-users`
  - 全部：`npx supabase functions deploy`
- 线上调试
  - 列表：`npx supabase functions list`
  - 下载：`npx supabase functions download <name>`
- 环境变量
  - 前端使用 `.env` 的 `VITE_SUPABASE_URL/ANON_KEY`
  - 函数端使用项目默认注入；切换为 anon 客户端并读取请求头 Authorization

—

### 风险与对策
- RLS 不足导致功能受限：先以最小策略放行必要查询，并逐步细化。
- 函数鉴权改造后报 401：检查前端是否传递 `Authorization: Bearer <access_token>`（supabase-js 会自动带）。
- 聚合性能：给高频字段加索引，如 `profiles(status, is_public)`, `checkins(user_id, date)`, `community_activities(user_id, activity_type, created_at)`。

—

### 验收清单（MVP）
- 登录后可正常学伴匹配、发起关注/好友请求。
- 未登录无法调用任何会写入的 Edge Functions。
- 学习/健身内容入口统一为内容中心，过滤一致、体验一致。
- 学习打卡/连续天数可用；周榜/周报页面可见。

---

我建议从 P0 开始执行：先改 Edge Functions 鉴权与 `id in` 过滤，再修前端导入与类型。如果你同意，我将直接提交这些 edits 并部署函数。随后进入内容中心合并。